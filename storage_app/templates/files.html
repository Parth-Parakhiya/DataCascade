{% extends "index.html" %}
{% load static %}
{% block content %}

<div class="page-container">
    <div class="page-header">
        <h2 class="section-title">My Files</h2>
        <p class="section-subtitle">Manage and access your uploaded documents</p>
    </div>

    <!-- File upload card -->
    <div class="upload-card">
        <div class="upload-card-header">
            <i class="fas fa-cloud-upload-alt feature-icon"></i>
            <h3>Upload New File</h3>
        </div>
        <div class="upload-card-body">
            <form id="upload-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_file_name">File name:</label>
                    {{ form.file_name }}
                </div>
                <div class="form-group">
                    <label for="id_description">Description:</label>
                    {{ form.description }}
                </div>
                <div class="form-group file-input-group">
                    <label for="id_file">Choose file:</label>
                    {{ form.file }}
                </div>
                <button type="submit" id="upload-submit-btn" class="btn btn-primary button-main">
                    <i class="fas fa-upload"></i> Upload File
                </button>
            </form>
        </div>
    </div>

    <!-- Download Progress Tracking -->
    <div id="download-status-container" class="status-container">
        <!-- Download statuses will be dynamically added here -->
    </div>

    <!-- Upload Progress Modal -->
    <div id="upload-progress-modal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-cloud-upload-alt"></i> File Upload Process</h3>

            <div class="progress-container">
                <div class="progress">
                    <div id="upload-progress-bar" class="progress-bar" role="progressbar"></div>
                </div>
                <div class="progress-text">0%</div>
            </div>

            <p id="upload-status-message" class="status-message">Preparing upload...</p>

            <!-- Upload Stages -->
            <div id="upload-stages" class="upload-stages">
                <!-- Stages will be dynamically inserted here -->
            </div>

            <!-- Success Animation (hidden by default) -->
            <div id="completion-animation" class="completion-animation">
                <div class="success-checkmark">
                    <div class="check-icon">
                        <span class="icon-line line-tip"></span>
                        <span class="icon-line line-long"></span>
                        <div class="icon-circle"></div>
                        <div class="icon-fix"></div>
                    </div>
                </div>
                <p>Upload successful!</p>
            </div>
        </div>
    </div>
    <!-- Files Table -->
    <div class="files-table-container">
        {% if files %}
        <div class="files-count">
            <span>{{ files|length }} file{% if files|length != 1 %}s{% endif %} found</span>
        </div>
        <div class="table-responsive">
            <table class="files-table">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Uploaded On</th>
                        <th>Last Downloaded</th>
                        <th>Actions</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in files %}
                    <tr>
                        <td class="file-name">
                            <i class="fas fa-file-alt file-icon"></i>
                            {{ file.file_name }}
                        </td>
                        <td class="file-size">
                            {% if file.file_size < 1024 %}

                                {{ file.file_size }} bytes

                            {% elif file.file_size < 1048576 %}

                                {% widthratio file.file_size 1024 1 %} KB

                            {% elif file.file_size < 1073741824 %}

                                {% widthratio file.file_size 1048576 1 %} MB

                            {% elif file.file_size < 1099511627776 %}

                                {% widthratio file.file_size 1073741824 1 %} GB

                            {% else %}

                                {% widthratio file.file_size 1099511627776 1 %} TB
                                
                            {% endif %}
                        </td>
                        <td>{{ file.uploaded_at|date:"F j, Y, g:i a" }}</td>
                        <td>
                            {% if file.last_downloaded_at %}
                            {{ file.last_downloaded_at|date:"F j, Y, g:i a" }}
                            {% else %}
                            <span class="never-downloaded">Never</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'download_file' file_id=file.file_id %}"
                                class="btn btn-primary download-btn" data-file-id="{{ file.file_id }}"
                                data-file-name="{{ file.file_name }}" download>
                                <i class="fas fa-download"></i> Download
                            </a>
                        </td>
                        <td>
                            <div id="download-status-{{ file.file_id }}" class="download-status"></div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-files">
            <i class="fas fa-folder-open empty-icon"></i>
            <p>No files to show. Upload your first file to get started.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const uploadForm = document.getElementById('upload-form');
        const uploadProgressModal = document.getElementById('upload-progress-modal');
        const uploadProgressBar = document.getElementById('upload-progress-bar');
        const uploadStatusMessage = document.getElementById('upload-status-message');
        const uploadSubmitBtn = document.getElementById('upload-submit-btn');
        const progressText = document.querySelector('.progress-text');
        const stagesContainer = document.getElementById('upload-stages');
        const downloadStatusContainer = document.getElementById('download-status-container');

        // Add event listeners to all download buttons
        document.querySelectorAll('.download-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                const fileId = this.getAttribute('data-file-id');
                const fileName = this.getAttribute('data-file-name');

                // Create or update the download status element
                const downloadStatusCell = document.getElementById(`download-status-${fileId}`);

                if (downloadStatusCell) {
                    // Show downloading status
                    downloadStatusCell.innerHTML = `
            <div class="download-progress">
                <div class="download-progress-bar"></div>
                <span class="download-progress-text">0%</span>
            </div>
            <div class="download-status-message">Preparing download...</div>
            `;

                    const progressBar = downloadStatusCell.querySelector('.download-progress-bar');
                    const progressTextElement = downloadStatusCell.querySelector('.download-progress-text');
                    const statusMessage = downloadStatusCell.querySelector('.download-status-message');

                    // Simulate download progress
                    let progress = 0;
                    const downloadInterval = setInterval(() => {
                        progress += 5;
                        if (progress > 100) {
                            clearInterval(downloadInterval);

                            // Show simple completion message with icon
                            downloadStatusCell.innerHTML = `
                    <div class="download-complete">
                        <i class="fas fa-check-circle"></i> Complete
                    </div>
                    `;

                            // Clear the status after some time
                            setTimeout(() => {
                                downloadStatusCell.innerHTML = '';
                            }, 10000); // 10 seconds

                            return;
                        }

                        // Update progress
                        progressBar.style.width = `${progress}%`;
                        progressTextElement.textContent = `${progress}%`;

                        // Update status message based on progress
                        if (progress < 20) {
                            statusMessage.textContent = 'Preparing';
                        } else if (progress < 50) {
                            statusMessage.textContent = 'Processing';
                        } else if (progress < 75) {
                            statusMessage.textContent = 'Downloading';
                        } else {
                            statusMessage.textContent = 'Finalizing...';
                        }
                    }, 200);
                }
            });
        });

        uploadForm.addEventListener('submit', function (e) {
            e.preventDefault();

            // Show progress modal
            uploadProgressModal.style.display = 'flex';
            uploadSubmitBtn.disabled = true;

            // Reset progress elements
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.className = 'progress-bar';
            progressText.textContent = '0%';

            // Initialize the upload stages
            stagesContainer.innerHTML = `
        <div class="upload-stage current" id="stage-chunking">
            <div class="stage-icon">
                <i class="fas fa-puzzle-piece fa-spin"></i>
            </div>
            <div class="stage-content">
                <h4>Chunking File</h4>
                <p>Breaking file into manageable pieces...</p>
            </div>
        </div>
        <div class="upload-stage" id="stage-preprocessing">
            <div class="stage-icon">
                <i class="fas fa-cogs"></i>
            </div>
            <div class="stage-content">
                <h4>Preprocessing</h4>
                <p>Optimizing file for upload...</p>
            </div>
        </div>
        <div class="upload-stage" id="stage-checksum">
            <div class="stage-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="stage-content">
                <h4>Generating Checksum</h4>
                <p>Verifying file integrity...</p>
            </div>
        </div>
        <div class="upload-stage" id="stage-uploading">
            <div class="stage-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="stage-content">
                <h4>Uploading to Server</h4>
                <p>Transferring file to storage...</p>
            </div>
        </div>
        <div class="upload-stage" id="stage-complete">
            <div class="stage-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stage-content">
                <h4>Complete</h4>
                <p>File successfully uploaded!</p>
            </div>
        </div>
    `;

            // Prepare form data
            const formData = new FormData(uploadForm);
            const file = formData.get('file');

            // Simulate chunking stage (3 seconds)
            updateStage('chunking', true);
            uploadStatusMessage.textContent = 'Preparing file for upload...';

            setTimeout(() => {
                // Mark chunking as complete and move to preprocessing
                updateStage('chunking', false, true);
                updateStage('preprocessing', true);
                uploadProgressBar.style.width = '20%';
                progressText.textContent = '20%';
                uploadStatusMessage.textContent = 'Processing file...';

                // Simulate preprocessing stage (2 seconds)
                setTimeout(() => {
                    // Mark preprocessing as complete and move to checksum
                    updateStage('preprocessing', false, true);
                    updateStage('checksum', true);
                    uploadProgressBar.style.width = '40%';
                    progressText.textContent = '40%';
                    uploadStatusMessage.textContent = 'Generating checksum...';

                    // Simulate checksum generation (2 seconds)
                    setTimeout(() => {
                        // Mark checksum as complete and start actual upload
                        updateStage('checksum', false, true);
                        updateStage('uploading', true);
                        uploadProgressBar.style.width = '50%';
                        progressText.textContent = '50%';
                        uploadStatusMessage.textContent = 'Starting upload to server...';

                        // Now start the actual AJAX upload
                        startActualUpload(formData);
                    }, 2000);
                }, 2000);
            }, 3000);
        });

        function updateStage(stageName, isActive, isComplete = false) {
            const stage = document.getElementById(`stage-${stageName}`);

            // Remove current class from all stages
            if (isActive) {
                document.querySelectorAll('.upload-stage').forEach(el => {
                    el.classList.remove('current');
                });
                stage.classList.add('current');
            } else if (isComplete) {
                stage.classList.remove('current');
                stage.classList.add('complete');

                // Update the icon to a checkmark
                const icon = stage.querySelector('.stage-icon i');
                icon.className = 'fas fa-check';
            }
        }

        function startActualUpload(formData) {
            // AJAX upload
            const xhr = new XMLHttpRequest();

            // Track upload progress
            xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                    // Scale the percentage to be between 50% and 95%
                    const percentComplete = Math.round(50 + (event.loaded / event.total) * 45);
                    uploadProgressBar.style.width = `${percentComplete}%`;
                    progressText.textContent = `${percentComplete}%`;
                    uploadStatusMessage.textContent = `Uploading: ${percentComplete}%`;
                }
            };

            xhr.onload = function () {
                uploadSubmitBtn.disabled = false;

                if (xhr.status === 200) {
                    // Complete the upload stage
                    updateStage('uploading', false, true);
                    updateStage('complete', true);

                    // Set to 100%
                    uploadProgressBar.style.width = '100%';
                    progressText.textContent = '100%';
                    uploadStatusMessage.textContent = 'Upload Complete!';
                    uploadProgressBar.classList.add('success');

                    // Show completion animation
                    document.getElementById('completion-animation').style.display = 'block';

                    // Redirect or refresh after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    // Error
                    uploadStatusMessage.textContent = 'Upload Failed. Please try again.';
                    uploadProgressBar.classList.add('error');
                }
            };

            xhr.onerror = function () {
                uploadSubmitBtn.disabled = false;
                uploadStatusMessage.textContent = 'Network Error. Please try again.';
                uploadProgressBar.classList.add('error');
            };

            // Send request
            xhr.open('POST', uploadForm.action, true);
            xhr.send(formData);
        }
    });
</script>
{% endblock %}